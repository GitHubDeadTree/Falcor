## 当前过滤实现

目前CPU端的过滤逻辑在 `PixelStats::copyCIRRawDataToCPU()`中实现，使用硬编码的过滤条件： **PixelStats.cpp:555**

过滤条件定义在 `CIRPathData::isValid()`方法中： **PixelStats.h:74-78**

## 实现方案

### 1. 添加可配置的过滤参数

在 `PixelStats`类中添加成员变量来存储过滤参数：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>// 在PixelStats.h中添加  </span><span>
</span><span></span><span>private</span><span>:
</span><span></span><span>// CIR filtering parameters  </span><span>
</span><span></span><span>float</span><span> mCIRMinPathLength = </span><span>1.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMaxPathLength = </span><span>200.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMinEmittedPower = </span><span>0.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMaxEmittedPower = </span><span>10000.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMinEmissionAngle = </span><span>0.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMaxEmissionAngle = </span><span>3.14159f</span><span>;
</span><span></span><span>float</span><span> mCIRMinReceptionAngle = </span><span>0.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMaxReceptionAngle = </span><span>3.14159f</span><span>;
</span><span></span><span>float</span><span> mCIRMinReflectanceProduct = </span><span>0.0f</span><span>;
</span><span></span><span>float</span><span> mCIRMaxReflectanceProduct = </span><span>1.0f</span><span>;</span></code></pre></pre>

### 2. 修改过滤逻辑

创建一个参数化的验证方法：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>// 在PixelStats.h中添加  </span><span>
</span><span></span>boolisValidCIRData(const CIRPathData& data)const
<span>{
</span><span></span><span>return</span><span> data.pathLength >= mCIRMinPathLength && data.pathLength <= mCIRMaxPathLength &&
</span>           data.emissionAngle >= mCIRMinEmissionAngle && data.emissionAngle <= mCIRMaxEmissionAngle &&
           data.receptionAngle >= mCIRMinReceptionAngle && data.receptionAngle <= mCIRMaxReceptionAngle &&
           data.reflectanceProduct >= mCIRMinReflectanceProduct && data.reflectanceProduct <= mCIRMaxReflectanceProduct &&
           data.emittedPower >= mCIRMinEmittedPower && data.emittedPower <= mCIRMaxEmittedPower;
}</code></pre></pre>

然后在过滤循环中使用这个方法替代 `rawData[i].isValid()`。

### 3. 添加UI控件

在 `PixelStats::renderUI()`方法中添加滑条控件，参考现有的UI实现模式： **PixelStats.cpp:304-336**

在CIR数据控制部分添加过滤参数的UI：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>// 在renderUI方法的CIR控制部分添加  </span><span>
</span><span></span><span>if</span><span> (mCollectionMode == CollectionMode::RawData || mCollectionMode == CollectionMode::Both)
</span>{
<span></span><span>// 现有的UI控件...  </span><span>
</span>
<span></span><span>// 添加过滤参数控制组  </span><span>
</span><span></span><span>auto</span><span> filterGroup = widget.</span><span>group</span><span>(</span><span>"CIR Filtering Parameters"</span><span>, </span><span>false</span><span>);
</span><span></span><span>if</span><span> (filterGroup)
</span>    {
<span>        widget.</span><span>slider</span><span>(</span><span>"Min Path Length (m)"</span><span>, mCIRMinPathLength, </span><span>0.1f</span><span>, </span><span>10.0f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Max Path Length (m)"</span><span>, mCIRMaxPathLength, </span><span>10.0f</span><span>, </span><span>500.0f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Min Emitted Power (W)"</span><span>, mCIRMinEmittedPower, </span><span>0.0f</span><span>, </span><span>1.0f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Max Emitted Power (W)"</span><span>, mCIRMaxEmittedPower, </span><span>100.0f</span><span>, </span><span>20000.0f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Min Emission Angle (rad)"</span><span>, mCIRMinEmissionAngle, </span><span>0.0f</span><span>, </span><span>1.57f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Max Emission Angle (rad)"</span><span>, mCIRMaxEmissionAngle, </span><span>1.57f</span><span>, </span><span>3.14159f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Min Reception Angle (rad)"</span><span>, mCIRMinReceptionAngle, </span><span>0.0f</span><span>, </span><span>1.57f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Max Reception Angle (rad)"</span><span>, mCIRMaxReceptionAngle, </span><span>1.57f</span><span>, </span><span>3.14159f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Min Reflectance Product"</span><span>, mCIRMinReflectanceProduct, </span><span>0.0f</span><span>, </span><span>0.5f</span><span>);
</span><span>        widget.</span><span>slider</span><span>(</span><span>"Max Reflectance Product"</span><span>, mCIRMaxReflectanceProduct, </span><span>0.5f</span><span>, </span><span>1.0f</span><span>);
</span>    }
}</code></pre></pre>

### 4. 添加访问器方法

为了支持外部配置，添加getter/setter方法：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>// 在PixelStats.h的public部分添加  </span><span>
</span><span></span>voidsetCIRPathLengthRange(float minLength, float maxLength)
<span>{
</span>    mCIRMinPathLength = minLength;
    mCIRMaxPathLength = maxLength;
}

<span></span>voidsetCIREmittedPowerRange(float minPower, float maxPower)
<span>{
</span>    mCIRMinEmittedPower = minPower;
    mCIRMaxEmittedPower = maxPower;
}

<span></span><span>// 其他参数的setter方法...</span></code></pre></pre>

## 参考实现

您可以参考 `IncomingLightPowerPass`中滑条控件的实现方式： **IncomingLightPowerPass.cpp:935-936**

这个实现展示了如何使用滑条控件来控制统计频率参数。

## Notes

这种实现方式允许用户在运行时动态调整CIR数据的过滤条件，而不需要重新编译代码。滑条控件提供了直观的参数调整界面，特别适合VLC研究中需要针对不同场景调整过滤标准的需求。建议将过滤参数保存到配置文件中，以便在不同会话间保持设置。
