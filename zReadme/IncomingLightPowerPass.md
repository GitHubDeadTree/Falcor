# 入射光线功率计算通道（IncomingLightPowerPass）实现计划

## 总体目标

创建一个新的渲染通道，用于计算射入摄像机的光线功率。该通道需要：

1. 计算射入相机像素的光线功率
2. 过滤特定波长范围的光线（只有在指定波长区间内的光线才参与计算）
3. 输出每个符合要求的光线的功率和波长信息

## 子任务分解

### 子任务1：创建基础通道框架

#### 任务目标

创建IncomingLightPowerPass的基本框架，包括必要的类定义、描述符和参数设置。

#### 实现方案

1. 创建 `IncomingLightPowerPass.h`和 `IncomingLightPowerPass.cpp`文件
2. 定义IncomingLightPowerPass类及其基本接口
3. 实现必要的RenderPass接口方法：
   - `create()`
   - `execute()`
   - `getProperties()`
   - `reflect()`等
4. 定义波长过滤范围参数
5. 将通道注册到RenderPassLibrary

#### 验证方法

- 通道可以成功编译并加载到Falcor中
- 通道显示在Render Graph编辑器中，可以添加到渲染管线
- 通道参数可以在UI中显示并调整

### 子任务2：实现CameraIncidentPower计算工具类

#### 任务目标

根据文档中的描述，实现用于计算入射光线功率的工具类。

#### 实现方案

1. 创建 `CameraIncidentPower`类（可作为IncomingLightPowerPass的嵌套类或独立工具类）
2. 实现文档中描述的三个主要功能：
   - `computePixelArea()` - 计算像素感光面积
   - `computeRayDirection()` - 计算光线方向
   - `computeCosTheta()` - 计算入射角余弦项
3. 实现主要的 `compute()`方法，根据辐射度、像素位置等计算入射功率

#### 验证方法

- 单元测试或简单测试场景验证计算结果
- 对比已知场景中的简单光源计算结果与理论值

### 子任务3：实现波长过滤功能

#### 任务目标

实现光线波长区间的过滤机制，只计算指定波长范围内的光线功率。

#### 实现方案

1. 在通道参数中添加波长范围设置（minWavelength和maxWavelength）
2. 在着色器代码中添加波长检测逻辑
3. 实现波长判断函数，判断当前光线是否在指定波长范围内
4. 修改功率计算逻辑，只对符合波长要求的光线进行计算

#### 验证方法

- 使用不同波长的光源测试过滤功能
- 验证超出范围的波长被正确过滤
- 验证边界情况（波长刚好等于边界值）

### 子任务4：与路径追踪器集成

#### 任务目标

将功率计算通道与Falcor的路径追踪器集成，获取路径追踪结果中的辐射度信息。

#### 实现方案

1. 在通道定义中添加对路径追踪结果的输入依赖
2. 实现从路径追踪结果中提取辐射度信息的逻辑
3. 对每个像素的光线进行波长判断和功率计算
4. 处理多样本情况下的功率累积和平均

#### 验证方法

- 与标准路径追踪结果比较，验证入射光线获取正确
- 在简单测试场景中验证功率计算结果

### 子任务5：实现结果输出与存储

#### 任务目标

实现将符合条件的光线功率和波长信息保存为可用格式。

#### 实现方案

1. 定义输出结构，包含光线功率和波长信息
2. 创建用于存储结果的纹理或缓冲区
3. 实现将计算结果写入输出缓冲区的逻辑
4. 提供访问和导出结果数据的接口

#### 验证方法

- 验证输出数据格式正确，包含所需的功率和波长信息
- 验证数据可以正确导出或在Falcor中可视化

### 子任务6：实现UI交互和参数调整

#### 任务目标

为通道添加用户界面，允许调整波长范围和其他参数。

#### 实现方案

1. 在 `renderUI()`方法中添加波长范围的滑动条或输入框
2. 添加其他相关参数的调整控件
3. 实现参数变化时的更新逻辑
4. 添加结果可视化选项

#### 验证方法

- UI控件可以正常显示和操作
- 参数变化能立即影响渲染结果
- 参数保存和加载功能正常工作

### 子任务7：性能优化与测试

#### 任务目标

确保通道在各种场景下性能良好，结果准确。

#### 实现方案

1. 分析计算瓶颈，考虑GPU优化策略
2. 实现必要的缓存机制减少重复计算
3. 考虑波长过滤的高效实现
4. 进行全面的场景测试和性能评估

#### 验证方法

- 性能分析工具显示合理的执行时间
- 在复杂场景下没有明显性能下降
- 不同硬件配置下功能正常

## 问题与考虑

1. 波长表示方式：Falcor中光线的波长是如何表示的？是否已有现成的波长提取机制？
2. 采样策略：多次采样时如何处理波长信息？是否需要特殊的累积策略？
3. 可视化方式：最终结果应该如何可视化以便于分析？
4. 性能考虑：波长过滤是否会引入显著的性能开销？

## 下一步行动

首先实现子任务1和子任务2，建立基础框架和核心计算逻辑，然后根据初步测试结果调整后续任务的优先级和实现方案。
