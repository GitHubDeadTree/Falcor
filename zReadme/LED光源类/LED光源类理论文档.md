# LED光源类设计需求文档

### 目标

在Falcor中实现一个新的LED光源类，支持不同几何形状、波谱属性、实时功率调节、角度衰减修正等特性，同时允许通过外部接口加载基于打表的光场分布，并在此基础上计算光强度。

### 需求分析

#### 1. **新增光源类型：LED**

在 `LightType` 枚举中新增 `LED` 类型，以便在场景中定义和区分LED光源。通过这种方式，LED可以像其他光源（例如点光源、面光源等）一样被处理和渲染。

#### 2. **扩展 ****`LightData`**** 结构：**

现有的 `LightData` 结构需要扩展，以便能够存储LED光源的特定数据：

* **变换矩阵** ：用于定义光源的几何形状，可以表示为一个3D变换矩阵。该矩阵可以将LED光源的标准几何形状（如球形、椭球、矩形等）变换到场景中的任何位置。
* **波谱分布** ：用于存储LED光源的光谱信息，可能包括连续谱或离散谱，描述了不同波长下的辐射强度。
* **功率** ：LED的总功率，用来计算光源的光强度。

这些数据字段将在LED光源类中进行管理和更新。

#### 3. **混合功能的实现：**

* **辐射角控制** ：LED光源应继承自 `PointLight` 的辐射角控制逻辑，基于开口半角和朗伯衰减公式，控制光源的辐射强度随角度的变化。
* **几何变换与表面积计算** ：LED光源需要借用自 `AnalyticAreaLight` 的几何变换和表面积计算方法，确保不同形状的光源能够正确计算其表面积。不同形状的光源（如球形、椭球、矩形等）需要应用相应的几何计算公式。
* **功率计算** ：LED光源的功率计算结合了 `PointLight` 和 `AnalyticAreaLight` 的功率计算方式，考虑到角度衰减和表面积分布，确保功率和光强度计算的准确性。

#### 4. **朗伯次数和角度衰减修正：**

LED光源的辐射强度将基于朗伯次数进行计算，朗伯次数描述了光源在不同方向上的强度衰减。对于LED光源，光强度随角度变化的计算公式为：

N=−log⁡(2)log⁡(cos⁡(θc))N = \frac{-\log(2)}{\log(\cos(\theta_c))}

其中，θc\theta_c 是光源的开口半角（例如，聚光灯的光锥半角），NN 是朗伯次数。光强度在某个给定角度θ\theta的计算公式为：

I(θ)=Iunit×cos⁡(θ)N+1I(\theta) = I_{\text{unit}} \times \frac{\cos(\theta)}{N + 1}

该公式确保了光源的辐射强度随着观察角度的不同而变化。

#### 5. **光场分布加载（新增功能）：**

除了默认的基于朗伯次数的角度衰减，我们还需要支持通过Python接口从外部加载打表的光场分布数据。打表的光场分布可以是通过实验、测量或其他方式获得的光源辐射数据，通常以角度（或其他参数）为索引。

**功能要求：**

* 提供Python接口，支持加载从外部载入的打表光场分布（例如，CSV文件或二进制格式）。
* 光场分布应包括角度衰减特性，通常是一个包含角度与相应光强度的表格。
* **计算光强度：** 在加载光场分布后，基于该表格计算光源的光强度。在这种情况下，光强度的计算不再依赖于朗伯衰减公式，而是直接从加载的光场分布数据中提取。

具体的步骤如下：

1. **从外部载入光场分布数据：** 通过Python接口，支持从外部加载打表数据。该数据应该包含一个角度和对应光强度的映射，可能是一个二维数组或表格，每一行包含一个角度（例如，弧度或度）和对应的光强度值。
2. **计算光强度：** 在加载光场数据后，光强度的计算方式变为：
   1. 对于某个给定的角度θ\theta，直接从加载的光场分布中查找对应的光强度值。假设光场数据是通过角度θ\theta表示为一系列表格数据的方式，我们可以通过插值或查表的方式获得光强度。
3. I(θ)=f(θ)I(\theta) = f(\theta)
4. 其中，f(θ)f(\theta) 是从加载的光场分布中获得的光强度值，可以通过线性插值或其他合适的方法获得。
5. **实时更新和功率计算：** 需要确保即使在加载了打表的光场分布之后，光源的总功率仍然被正确维护，并且能够根据功率变化动态调整光强度。

#### 6. **波谱分布加载：**

LED光源可以从外部加载波谱数据。波谱分布描述了光源在不同波长下的辐射功率。根据用户输入的波谱数据，我们需要：

* 支持连续谱和不连续谱两种形式；
* 如果没有提供波谱数据，使用一个默认的均匀光谱分布。

每个波长下的光强度将根据以下公式计算：

I(θ,λ)=P(λ)A×cos⁡(θ)N(λ)+1I(\theta, \lambda) = \frac{P(\lambda)}{A} \times \frac{\cos(\theta)}{N(\lambda) + 1}

其中，P(λ)P(\lambda) 是波长 λ\lambda 下的辐射功率，N(λ)N(\lambda) 是该波长下的朗伯次数，AA 是表面积。

#### 7. **支持多种几何形状的光源：**

LED光源的碰撞箱需要支持多种形状，如球形、椭球形和矩形等。根据不同的几何形状，光源的表面积计算公式不同：

* **球形光源** ：表面积公式为 A=4πr2A = 4\pi r^2。
* **椭球光源** ：椭球的表面积计算较为复杂，需要根据长短轴的比值进行推导，通常通过数值近似方法进行计算。
* **矩形光源** ：表面积计算公式为 A=2lw+2lh+2whA = 2lw + 2lh + 2wh，其中 ll、ww 和 hh 分别是矩形的长、宽、高。

根据这些不同的几何形状，我们需要实现相应的表面积计算方式。

#### 8. **碰撞检测：**

LED光源的碰撞箱不仅支持球形，还需要支持椭球、矩形等形状。为了确保光线与光源正确地发生碰撞，我们需要查阅并了解 `PathTracer` 的光线击中策略，并基于此扩展LED光源的碰撞检测机制。

#### 9. **实时调节光源功率：**

LED光源的功率可以实时调节，单位为瓦特（W）。功率Φ\Phi与光强度II之间的关系如下：

Iunit=ΦAI_{\text{unit}} = \frac{\Phi}{A}

当功率值变化时，LED的光强度也应随之调整，并且需要实时更新计算结果。

#### 10. **光源采样与波长强度获取：**

为了从LED光源采样光线并计算光强度，我们需要：

* 根据光源的几何形状、表面积、波谱分布等信息来计算光线的强度；
* 提供接口获取特定波长下的光强度，以支持光线的波长采样。

采样过程应考虑光源的形状、辐射特性及波谱分布，通过这些数据计算出最终的光强度。

### 总结

在这个更新后的需求文档中，除了基本的LED光源功能外，我们新增了通过Python接口加载打表光场分布的能力。光场分布的引入使得光源的角度衰减不再局限于朗伯衰减模型，而是允许用户通过外部数据提供更准确的光源方向性描述。其他功能包括：

* 支持不同几何形状的光源；
* 支持波谱分布加载；
* 实现光源功率调节和光强度计算。

这些功能的结合将使得LED光源更加灵活、可定制，并适应多种不同的应用场景。
