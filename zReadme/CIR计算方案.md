# 我的要求

我现在需要【基于Falcor的路径追踪来计算CIR（信道冲激响应）】。我现在给你理论方案，请你根据这个方案，并结合【Faclor】项目的代码实际，给出代码实现方案。并遵从以下要求：

1. 最小化对PathTracer渲染通道的修改。PathTracer只负责收集必不可少的计算CIR用的原始数据。复杂的计算应该创建新的渲染通道来实现。
2. 说明整个CIR计算的全流程，说明PathTracer在这个流程中负责什么。你是否创建新的渲染通道用于计算，说明这个渲染通道负责什么。PathTracer与这个渲染通道如何通信，使用的数据格式是什么。说明你要如何对PathTracer进行修改。
3. 你对PathTracer的修改，应该使用最稳定，成功率最大的方案。

你需要给出代码实现，并引用项目中的相关代码块

【以下是理论方案】

# 可见光通信中基于路径追踪的信道冲激响应（CIR）计算方法

## 一、路径追踪法计算 CIR 的基本原理

在路径追踪（Ray Tracing）方法中，每一条路径代表光从发射器（LED）经过若干反射后到达接收器的传播路径。信道冲激响应 CIR 就是所有这些路径在时间和功率上的综合表现：


其中：

* **
  $$
  h(t
  $$

  **：就是信道冲激响应（CIR）
* **
  $$
  P_
  $$

  **：第 **$$$$** 条路径在接收端的接收功率
* **
  $$
  \tau_
  $$

  **：第 **$$$$** 条路径的传播时延（秒）
* **
  $$
  \delta(t - \tau_i
  $$

  **：单位冲激函数（理想时延响应）

## 二、你需要收集的数据（路径追踪输出）

你需要从路径追踪器中收集以下每条路径的参数：

| 参数名称                 | 描述说明                             |
| ------------------------ | ------------------------------------ |
| **
$$
d_
$$

**`` | 第**$$$$**条路径的总传播距离（米） |
| **
$$
\phi_
$$

**       | 发射角（LED出射角，单位弧度）        |
| **
$$
\theta_
$$

**     | 接收角（接收器入射角，单位弧度）     |
| **
$$
r_
$$

**          | 第**$$$$**次反射的表面反射率       |
| **
$$
K_
$$

**          | 第**$$$$**条路径的反射次数         |
| **
$$
P_
$$

**          | 发射功率（瓦）                       |

## 三、计算每条路径的功率增益 **
$$
H_
$$

**

每条路径在接收端的功率计算为：


其中路径增益

 的表达式如下（简化模型）：




参数说明：

* **$$$$**：接收器有效面积（单位：平方米）
*  **m = -\frac{\ln 2}{\ln(\cos(\Phi_{1/2}))}$$**

  其中


   是 LED 的半功率角
*  ：多次反射带来的能量衰减
*   和 **
  $$
  \cos(\theta_i
  $$

  **：考虑了出射与入射角对光强的影响

## 四、计算路径传播时延 **
$$
\tau_
$$

**

每条路径的传播时延为：



* **
  $$
  c \approx 3 \times 10^8 \, \text{m/s
  $$

  **：光在空气中的传播速度

## 五、形成离散的 CIR 向量

由于在计算机中无法直接表示理想的

 函数，我们通常将 **
$$
h(t
$$

** 表示为一个离散时间序列。例如使用纳秒级时间分辨率：

```Python
# Python 伪代码
time_resolution = 1e-9  # 1 ns
max_delay = max(tau_list)
num_bins = int(max_delay / time_resolution) + 1
cir = np.zeros(num_bins)

for i in range(num_paths):
    bin_index = int(tau_list[i] / time_resolution)
    cir[bin_index] += P_list[i]
```

## 七、总结：路径追踪法 CIR 计算流程图

1. 执行路径追踪，记录每条路径的参数（**
   $$
   d_i, \phi_i, \theta_i, r_
   $$

   ** 等）
2. 计算每条路径的功率贡献 **
   $$
   P_
   $$

   **
3. 计算每条路径的传播时延 **
   $$
   \tau_
   $$

   **
4. 将所有路径叠加为 **
   $$
   h(t) = \sum P_i \cdot \delta(t - \tau_i
   $$

   **
5. 离散化并可视化 CIR，用于后续分析

# 可见光通信中路径追踪法计算 CIR 所需的参数清单与说明

如果采用路径追踪法来计算 CIR，在软件端确实需要为每条路径收集一组关键参数。这些参数可以让你完整地求出每条路径的时延和功率贡献，从而构建 CIR。

## 每条路径需要收集的6个核心参数（你已经想到的）：

| 参数                        | 含义                             | 用途                                                     |
| --------------------------- | -------------------------------- | -------------------------------------------------------- |
| **
$$
d_
$$

**             | 路径总长度                       | 计算时延：**
$$
\tau_i = \frac{d_i}{c
$$

**             |
| **
$$
\phi_
$$

**          | 光源出射角                       | 用于计算 Lambertian 发射强度：**
$$
\cos^m(\phi_i
$$

** |
| **
$$
\theta_
$$

**        | 接收器入射角                     | 计算接收角度衰减：**
$$
\cos(\theta_i
$$

**             |
| **
$$
K_
$$

**             | 路径中的反射次数                 | 统计路径复杂度，决定乘多少个反射衰减因子                 |
| **
$$
r_
$$

**（或其乘积） | 每次反射的表面反射率（或总乘积） | 计算路径上的能量损耗：**
$$
\prod_{k=1}^{K_i} r_
$$

**  |
| **
$$
P_
$$

**             | 发射功率                         | 每条路径的起始功率基准                                   |

## 还需要额外收集的场景和接收端固定参数（不随路径变化）：

这些不是每条路径独有的，但你仍需要在软件中定义它们用于计算所有路径的功率。

| 参数                    | 含义             | 示例/说明                                                            |
| ----------------------- | ---------------- | -------------------------------------------------------------------- |
| **$$$$**        | 接收器面积       | 单位是**
$$
m^
$$

**，如 1**
$$
cm^2 = 1e-4\, m^
$$

**                   |
| **
$$
\Phi_{1/2
$$

**  | LED 半功率角     | 用于求朗伯阶数**
$$
**：**
$$

m = -\frac{\ln 2}{\ln(\cos(\Phi_{1/2}))$$** |
| **$$$$**        | 光速             | **
$$
3 \times 10^8\, m/
$$

**（固定）                              |
| **
$$
FO
$$

**         | 接收器视场角     | 可用于筛除视角超过范围的路径                                         |
| **
$$
T_s(\theta
$$

** | 光学滤波器透过率 | 如无滤波器可设为 1                                                   |
| **
$$
g(\theta
$$

**   | 光学集中增益     | 通常用于透镜增益，如无则设为 1                                       |

## 小结

你至少要为每条路径收集如下 6 个参数用于计算 CIR：

* **
  $$
  d_
  $$

  **：路径长度
* **
  $$
  \phi_
  $$

  **：出射角
* **
  $$
  \theta_
  $$

  **：入射角
* **
  $$
  r_
  $$

  ** 或其乘积：反射率
* **
  $$
  K_
  $$

  **：反射次数
* **
  $$
  P_
  $$

  **：发射功率（同一源可为常数）

同时，还需定义整个系统的静态参数（LED角度、接收器面积等6个参数），用于功率模型。

# 数据分析

## 每条路径需要收集的6个核心参数

| 参数 | 描述                   | Falcor中是否存在 | 获取方式/位置                                                                        |
| ---- | ---------------------- | ---------------- | ------------------------------------------------------------------------------------ |
| d_i  | 路径总传播距离         | ✅ 存在          | PathState结构中的sceneLength字段直接提供路径长度 PathState.slang:90                  |
| φ_i | 发射角（LED出射角）    | ✅ 可计算        | 通过ray direction和surface normal的点积计算cosine值 PathState.slang:94-97            |
| θ_i | 接收角（接收器入射角） | ✅ 可计算        | 类似发射角，可通过光线方向和接收面法向量计算 IncomingLightPowerPass.cs.slang:215-241 |
| r_i  | 表面反射率             | ✅ 存在          | Fresnel方程提供精确的反射率计算，包括电介质和导体材质 Fresnel.slang:67-92            |
| K_i  | 反射次数               | ✅ 存在          | PathState中的bounceCounters跟踪不同类型的反射次数 PathState.slang:184-201            |
| P_t  | 发射功率               | ✅ 可获取        | 可从路径的radiance值和材质属性计算 PathState.slang:100-101                           |

## 系统中需要的6个静态参数

| 参数    | 描述             | Falcor中是否存在 | 获取方式/说明                                                                        |
| ------- | ---------------- | ---------------- | ------------------------------------------------------------------------------------ |
| A       | 接收器有效面积   | ⚠️ 需要定义    | 需要在参数中手动定义，可参考像素面积计算方法 IncomingLightPowerPass.cs.slang:194-213 |
| m       | LED朗伯阶数      | ⚠️ 需要计算    | 需要根据LED半功率角使用公式计算，Falcor支持朗伯发射模型 LambertDiffuseBRDF.slang:1   |
| c       | 光传播速度       | ✅ 常数          | 物理常数，可直接定义为3×10⁸ m/s                                                    |
| FOV     | 接收器视场角     | ✅ 存在          | 相机参数中包含视场角信息 IncomingLightPowerPass.cs.slang:76-80                       |
| T_s(θ) | 光学滤波器透过率 | ⚠️ 需要定义    | 需要在材质系统中定义，可利用现有的材质属性框架                                       |
| g(θ)   | 光学集中增益     | ⚠️ 需要定义    | 需要在材质系统中定义，可结合透镜或反射器模型                                         |

## 总结

Falcor路径追踪器能够提供CLR计算所需的大部分核心参数：

✅ 完全支持 (8/12)：路径长度、角度计算、反射率、反射次数、发射功率、光速、视场角、基础朗伯模型

⚠️ 需要扩展 (4/12)：接收器面积、精确朗伯阶数、滤波器透过率、光学增益

建议实现方案：

1. 直接使用Falcor现有的路径追踪数据获取大部分参数
2. 通过扩展材质系统或添加自定义参数来定义缺失的静态参数
3. 利用现有的角度计算和Fresnel方程来获得精确的光学参数

## Notes

Falcor的路径追踪器设计得相当完整，提供了计算CLR所需的核心光学参数。主要的限制在于一些特定的可见光通信参数（如LED特性、接收器参数）需要额外定义，但这些都可以通过扩展现有的材质和参数系统来实现。PathState结构特别适合跟踪每条路径的状态信息，而Fresnel方程提供了准确的反射/透射计算。
