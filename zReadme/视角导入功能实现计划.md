# 视角导入功能实现计划

## 任务复述

在Falcor的Scene Settings UI中，当前已经存在"Save Viewpoints"按钮，可以将当前所有视角信息导出为文本文件。现在需要在"Save Viewpoints"按钮旁边新增一个"Load Viewpoints"按钮，用于导入之前保存的视角信息文件，实现视角信息的恢复和重用功能。

导入的文件格式与导出格式保持一致，包含时间点和Transform信息：
```
timePoint, Transform(position = float3(x, y, z), target = float3(x, y, z), up = float3(x, y, z))
```

## 子任务分解

### 子任务1：在Scene.h中添加loadViewpoints方法声明

**1. 任务目标**
在Scene类的公共接口中添加loadViewpoints方法声明，为视角导入功能提供接口。

**2. 实现方案**
在Scene.h文件中的合适位置（与其他viewpoint相关方法一起）添加方法声明：
```cpp
void loadViewpoints();
```

**3. 错误处理**
此步骤为方法声明，无需错误处理。

**4. 验证方法**
编译代码，确保没有语法错误。检查方法声明是否正确添加到Scene类的公共接口中。

---

### 子任务2：实现字符串解析工具函数

**1. 任务目标**
创建用于解析视角文件格式的工具函数，能够从文本行中提取float3值（position、target、up）。

**2. 实现方案**
在Scene.cpp中实现私有辅助函数：
```cpp
bool parseFloat3FromString(const std::string& str, const std::string& prefix, float3& result);
bool parseViewpointLine(const std::string& line, float& timePoint, float3& position, float3& target, float3& up);
```

**3. 错误处理**
- 解析失败时返回false并输出logWarning
- 格式不匹配时返回默认值float3(0,0,0)
- 数值转换异常时捕获并返回false

**4. 验证方法**
创建测试用的格式化字符串，验证解析函数能够正确提取position、target、up的float3值。解析成功返回true，失败返回false并有相应日志输出。

---

### 子任务3：实现loadViewpoints核心功能

**1. 任务目标**
实现loadViewpoints方法的核心逻辑，包括文件对话框、文件读取、解析和viewpoint添加。

**2. 实现方案**
```cpp
void Scene::loadViewpoints()
{
    // 1. 打开文件对话框
    // 2. 清除现有viewpoints（保留默认）
    // 3. 逐行读取和解析文件
    // 4. 调用addViewpoint添加解析出的viewpoint
    // 5. 更新UI状态
}
```

**3. 错误处理**
- 文件打开失败：logError并返回
- 文件读取异常：logError并关闭文件
- 解析失败的行：logWarning并跳过该行，继续处理其他行
- 无有效viewpoint：logWarning并保持原状

**4. 验证方法**
- 成功导入：检查mViewpoints大小是否正确增加
- 失败情况：检查错误日志是否正确输出
- UI更新：确认viewpoint下拉列表正确显示新导入的viewpoints

---

### 子任务4：在UI中添加Load Viewpoints按钮

**1. 任务目标**
在Scene.cpp的renderUI方法中，在"Save Viewpoints"按钮后添加"Load Viewpoints"按钮。

**2. 实现方案**
在renderUI方法中找到Save Viewpoints按钮的位置（Scene.cpp:2009-2038），在其后添加：
```cpp
if (widget.button("Load Viewpoints", true)) loadViewpoints();
```

**3. 错误处理**
此步骤为UI添加，错误处理已在loadViewpoints方法中实现。

**4. 验证方法**
- UI显示：确认"Load Viewpoints"按钮正确显示在"Save Viewpoints"按钮旁边
- 按钮功能：点击按钮能够正确调用loadViewpoints方法
- 界面布局：确认按钮添加后UI布局正常

---

### 子任务5：测试和验证完整功能

**1. 任务目标**
进行端到端测试，验证视角导入功能的完整性和稳定性。

**2. 实现方案**
测试场景包括：
- 正常导入：使用之前保存的有效viewpoints文件
- 异常文件：测试空文件、格式错误文件、不存在文件
- 边界情况：测试单个viewpoint、大量viewpoints
- UI交互：测试导入后的viewpoint选择和切换

**3. 错误处理**
验证各种错误情况下的日志输出是否正确，程序是否稳定运行。

**4. 验证方法**
- 功能正常：能够成功导入并使用保存的viewpoints
- 错误处理：异常情况下有合适的错误信息，程序不崩溃
- 性能表现：导入操作响应及时，不影响UI交互
- 数据一致性：导入的viewpoint数据与原始保存数据一致

---

## 实现顺序

按照以下顺序执行子任务：
1. 子任务1（方法声明）
2. 子任务2（解析工具函数）
3. 子任务3（核心功能实现）
4. 子任务4（UI按钮添加）
5. 子任务5（测试验证）

## 注意事项

- 保持与现有代码风格一致
- 确保不影响现有viewpoint功能
- 合理的错误处理和用户提示
- 考虑文件格式兼容性
- 遵循Falcor的编码规范
