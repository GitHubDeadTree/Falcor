根据您的修正方案和Falcor项目的代码实际情况，我来提供一个完整的可开关的代码实现方案。

## 实现方案概述

您希望在Falcor的PathTracer中实现：当光线击中发光表面后立即终止路径追踪（无论是直射还是反射），并且这个功能应该是可配置的。

## 具体实现步骤

### 1. 添加配置参数

首先需要在 `PathTracerParams`结构中添加控制开关。在 **PathTracer.slang:71** 的 `PathTracerParams`结构中添加：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code>structPathTracerParams
<span>{
</span><span></span><span>// 现有参数...  </span><span>
</span>
<span></span><span>bool</span><span> terminateOnEmissiveHit = </span><span>false</span><span>;  </span><span>///< VLC模式：是否在击中发光表面后立即终止路径  </span><span>
</span>};</code></pre></pre>

### 2. 修改handleHit函数中的发光处理逻辑

在 **PathTracer.slang:984-1018** 的发光贡献计算后，添加VLC专用的终止逻辑：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>if</span><span> (computeEmissive</span> && <span>any(bsdfProperties.emission > </span><span>0.</span><span>f))
</span>{
<span></span><span>// 现有的MIS权重计算和发光贡献累积代码...  </span><span>
</span><span></span><span>// (保持原有的984-1018行代码不变)  </span><span>
</span>
<span></span><span>// === 新增：VLC专用光源击中终止逻辑 ===  </span><span>
</span><span></span><span>if</span><span> (params.terminateOnEmissiveHit)
</span>    {
<span></span><span>// 在终止前确保CIR数据已正确更新  </span><span>
</span><span></span><span>if</span><span> (path.is</span>Hit() && <span>length(sd.faceN) > </span><span>0.1</span><span>f)
</span>        {
<span>            path.update</span>CIRReceptionAngle(path.dir, sd.faceN)<span>;
</span>        }

<span></span><span>// 输出CIR数据（如果启用）  </span><span>
</span><span>        output</span>CIRDataOnPathCompletion(path)<span>;
</span>
<span></span><span>// 终止路径，无论是直射还是反射击中  </span><span>
</span><span>        path.terminate</span><span>()</span><span>;
</span>        return;
    }
}</code></pre></pre>

### 3. 更新CIR数据处理逻辑

在 **PathTracer.slang:1322-1330** 的 `updateCIRDataDuringTracing`函数中，增强对发光材料的处理：

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>void</span><span> updateCIRDataDuringTracing(</span><span>inout</span><span> PathState path, </span><span>float</span><span>3 surfaceNormal, BSDFProperties bsdfProperties)
</span>{
<span></span><span>const</span><span></span><span>uint</span><span> vertexIndex = path.getVertexIndex();
</span><span></span><span>const</span><span></span><span>bool</span><span> isPrimaryHit = (vertexIndex == </span><span>1</span><span>);
</span>
<span></span><span>// Strategy 1: Check for emissive materials (LED modeled as emissive surfaces)  </span><span>
</span><span></span><span>if</span><span> (any(bsdfProperties.emission > </span><span>0.0f</span><span>))
</span>    {
        path.updateCIREmissionAngle(surfaceNormal);

<span></span><span>// 如果启用了VLC模式，标记这是光源击中事件  </span><span>
</span><span></span><span>if</span><span> (params.terminateOnEmissiveHit)
</span>        {
<span></span><span>// 可以在这里添加额外的VLC特定数据记录  </span><span>
</span><span></span><span>// 例如标记光源类型、击中时间等  </span><span>
</span>        }
    }
<span></span><span>// 保持其余现有逻辑不变...  </span><span>
</span>}</code></pre></pre>

### 4. 确保CIR数据输出的完整性

由于路径会提前终止，需要确保 **PathTracer.slang:1389-1403** 中的 `outputCIRDataOnPathCompletion`函数能正确处理提前终止的情况。

### 5. 添加C++端的参数控制

在PathTracer的C++实现中，需要添加对应的参数设置接口，允许用户通过UI或脚本控制这个功能的开关。

## 实现要点

1. **条件控制** ：通过 `params.terminateOnEmissiveHit`参数控制功能开关
2. **无条件终止** ：一旦检测到发光表面且功能开启，立即终止路径（不区分主要/非主要击中点）
3. **数据完整性** ：在终止前确保CIR数据（特别是接收角度）已正确更新
4. **向后兼容** ：默认关闭此功能，不影响现有渲染管线

## 使用方式

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>// C++端设置  </span><span>
</span><span>pathTracerParams.terminateOnEmissiveHit = </span><span>true</span><span>;  </span><span>// 启用VLC模式  </span><span>
</span>
<span></span><span>// 或通过Python脚本  </span><span>
</span>pathTracer.params.terminateOnEmissiveHit = True</code></pre></pre>

这个实现方案确保了：

* **相机→发光平面** ：会终止（直射光线被接收）
* **相机→墙面→发光平面** ：会终止（反射光线被接收）
* **功能可控** ：可以通过参数开关控制是否启用此行为
* **数据完整** ：CIR数据在路径终止前得到正确更新

## Notes

这个修改完全符合VLC系统的物理特性，其中发光平面既是光源也是接收端（PD），光线一旦击中就应该被接收而不是继续传播。通过参数控制确保了功能的灵活性，不会影响其他渲染用途。
