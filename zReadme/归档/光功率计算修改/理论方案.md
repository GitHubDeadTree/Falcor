### 光功率计算修改需求文档

#### 一、需求背景

目前，我们的光功率计算方式存在一些问题，导致计算的结果与物理规律不符。尤其是在**多束光照射到探测器**的情况下，我们计算的 **总功率** 与 **平均功率** 之间的关系出现了不合理的情况，无法准确反映光源与探测器之间的功率分布规律。为了修复这个问题，我们需要对当前的光功率计算方式进行修改，使其符合物理定律，并确保系统的计算更为准确。

#### 二、需求说明

1. **总功率** ：我们需要计算整个探测器接收到的  **总光功率** ，而不是通过累加每个像素的功率值来得到总功率。当前的方法使用了每个像素的功率累加和，这会导致功率的高估并不符合实际情况。
2. **像素功率** ：在多个像素的情况下，光功率应该是根据每个像素的实际接收面积与辐照度来计算的。但当前实现中，像素面积被统一设置为整个传感器面积，导致功率计算不准确。
3. **物理合理性** ：当前的计算方式未能正确处理光的衰减和每个像素接收的光强度，尤其在 **距离变化** 时，应该考虑光强随距离衰减的规律 E(r)∼1r2E(r) \sim \frac{1}{r^2}。

### 三、当前问题分析

1. **总功率计算存在问题：**

   目前的总功率是通过**所有有效像素功率值的累加和**计算的。每个像素的功率被单独计算后加和，导致 **Total Power** 随像素数量变化而变化。但实际上，我们应该根据整个探测器的面积计算总功率，单独计算每个像素的功率并进行累加是不必要的。正确的方式是通过总面积和总辐照度直接计算总功率。
   目前的计算方式：

   Preceived=∑all pixelsPpixelP_{\text{received}} = \sum_{\text{all pixels}} P_{\text{pixel}}
   这种方式虽然能得出一个总功率值，但它并没有按照物理定律正确地反映出每个像素对总功率的贡献。
2. **像素面积的使用不当：**

   当前实现中，**每个像素的功率** 是基于整个传感器的面积 AsensorA_{\text{sensor}} 来计算的。这意味着每个像素的功率被人为地高估了。实际上，每个像素接收到的光功率应根据 **像素面积** 来计算，而不是整个传感器面积。
   目前的计算方法：

   Ppixel=E⋅Asensor⋅cos⁡θP_{\text{pixel}} = E \cdot A_{\text{sensor}} \cdot \cos\theta
   这种计算方法是错误的，因为每个像素应该有自己的面积 ApixelA_{\text{pixel}}，而不是直接使用整个传感器的面积。
3. **距离的影响未被考虑：**

   当前实现中，**每个像素的功率** 不随距离变化而变化。根据物理原理，光强 EE 随着距离 rr 增加应呈 1r2\frac{1}{r^2} 的衰减。当前的计算未能正确反映这一点，导致 **Total Power** 和 **Average Power** 随距离变化时的计算不准确。
4. **平均功率计算的不合理：**

   当前的计算方式导致 **Average Power** 不随距离变化，这与物理定律相违背。每个像素的功率应随距离变化，因此平均功率也应随着距离变化。

---

### 四、光功率计算修复方案

为了解决以上问题，我们将对当前的光功率计算方式进行修改，确保计算结果符合物理规律，并且更加高效和精确。以下是详细的修改方案：

#### 1. **总功率的计算**

总功率应当通过以下公式计算：

Ptotal=Etotal⋅APD⋅cos⁡θP_{\text{total}} = E_{\text{total}} \cdot A_{\text{PD}} \cdot \cos\theta
其中：

* EtotalE_{\text{total}} 是  **总光强** ，即从光源到 PD 面板的平均辐照度（单位：W/m²）。
* APDA_{\text{PD}} 是整个探测器的  **总接收面积** 。
* cos⁡θ\cos\theta 是光线入射与探测器法线之间的夹角修正因子。

**关键点：**

* **不需要逐像素计算功率** ，直接通过整个面板的面积计算总功率即可。
* 每个像素的功率不再需要单独累加，避免了多余的计算和误差。

#### 2. **每个像素的功率计算**

每个像素的功率应基于像素的实际面积计算：

Ppixel=Epixel⋅Apixel⋅cos⁡θP_{\text{pixel}} = E_{\text{pixel}} \cdot A_{\text{pixel}} \cdot \cos\theta
其中：

* EpixelE_{\text{pixel}} 是该像素接收到的光强，考虑到距离和角度，可能会随着位置不同而有所变化。
* ApixelA_{\text{pixel}} 是该像素的  **实际面积** ，而不是整个传感器的面积。
* cos⁡θ\cos\theta 是该像素的光线入射角。

修复后，**每个像素的功率** 将根据它实际接收的光强 EpixelE_{\text{pixel}} 和面积 ApixelA_{\text{pixel}} 计算。

#### 3. **光强与距离的关系**

要使计算符合物理规律，我们需要引入光强随距离的衰减公式：

Epixel=Etotalr2⋅cos⁡θE_{\text{pixel}} = \frac{E_{\text{total}}}{r^2} \cdot \cos\theta
其中：

* rr 是光源到该像素的距离；
* EpixelE_{\text{pixel}} 随着距离的增加按 1r2\frac{1}{r^2} 衰减。

这将确保 **每个像素的功率** 随距离增加而减少，符合光学中的辐射衰减规律。

#### 4. **平均功率的计算**

**Average Power** 应该反映每个像素接收到的功率与有效像素数量的关系，而不应该保持不变：

Paverage=Ptotal有效像素数P_{\text{average}} = \frac{P_{\text{total}}}{\text{有效像素数}}
随着距离变化，每个像素的接收功率会变化，因此 **Average Power** 也应该随之变化。

---

### 五、可能的挑战与解决方案

1. **像素面积与像素数量的关系：**
   * 当 PD 面板上的像素数量非常多时，像素面积的计算需要精确。如果每个像素的面积过小，累加计算可能会受到精度影响。为了提高精度，我们可以采用  **浮动的像素面积** ，在不同的计算阶段动态调整计算方式。
2. **距离变化对计算的影响：**
   * 距离变化会影响  **每个像素的光强** 。为了更好地模拟这一过程，我们需要确保每个像素的光强根据距离正确计算。使用 **基于网格的距离计算** 方法，可以在不同区域内更精确地计算每个像素的功率。
3. **性能优化：**
   * 对于高分辨率的 PD 面板，逐像素计算可能会对性能产生较大影响。我们可以考虑对光强的计算进行  **空间分块** ，将整个面板划分为多个区域，针对每个区域统一计算功率，从而减少计算量。

---

### 六、总结与要点

1. **总功率计算** 应基于总面积和总辐照度，避免逐像素计算。
2. **每个像素的功率** 应考虑该像素的实际面积和光强，遵循 1r2\frac{1}{r^2} 的衰减规律。
3. **平均功率** 应随着每个像素功率的变化而变化，而非保持不变。
4. 通过修复总功率计算方法，能确保系统的计算结果符合物理规律，并提高光功率计算的准确性。

这些修改将使得系统更符合物理模型，解决当前计算中存在的问题，并确保 **总功率** 和 **平均功率** 随距离变化时的一致性。
