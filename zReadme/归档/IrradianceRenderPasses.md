# 辐照度渲染通道实现分析

本文档详细介绍了Falcor引擎中与辐照度计算相关的三个主要渲染通道：IrradiancePass、AccumulatePass（用于辐照度累积）和ToneMapper（用于辐照度的色调映射）。每个渲染通道都有特定的输入、输出、实现方法和调试选项。

## 1. IrradiancePass（辐照度计算通道）

### 1.1 输入

| 输入通道 | 描述 | 类型 |
|---------|------|------|
| `initialRayInfo` | 光线初始方向(xyz)与强度(w)信息 | Texture2D<float4> |
| `vbuffer` | 可见性缓冲区（用于表面识别，可选） | Texture2D<uint> |

### 1.2 输出

| 输出通道 | 描述 | 类型 |
|---------|------|------|
| `irradiance` | 每像素辐照度值 | Texture2D<float4> (RGBA32Float) |

### 1.3 实现方法

IrradiancePass负责将路径追踪器提供的初始光线方向和辐射亮度（强度）数据转换为辐照度（每单位面积的辐射通量）。其核心实现原理如下：

1. **辐照度计算公式**：E = L * cos(θ) = L * (N·ω)
   - L：辐射亮度（来自输入纹理的intensity值）
   - θ：光线方向与表面法线之间的夹角
   - N：表面法线（可以是固定的或从几何体获取的实际法线）
   - ω：光线方向（根据设置可能会被反转）

2. **计算流程**：
   - 读取输入的光线方向和强度
   - 确定使用的法线（固定法线或实际几何体法线）
   - 计算余弦项 (N·ω)
   - 计算辐照度 E = L * cosθ * 强度缩放因子
   - 输出结果到辐照度纹理

3. **计算优化**：
   - 计算间隔控制：可配置基于时间或帧数的计算间隔，减少不必要的计算
   - 结果复用：可在跳过计算的帧中重用上一次的结果

4. **实际法线模式**：
   - 当启用`useActualNormals`时，使用VBuffer和场景数据获取实际几何体的法线
   - 这需要将场景数据绑定到着色器，并使用HitInfo从VBuffer中提取表面信息

### 1.4 调试选项

| 选项 | 描述 | 作用 |
|-----|------|------|
| `Enabled` | 启用/禁用辐照度计算 | 控制整个通道的执行 |
| `Compute Interval` | 计算间隔控制 | 设置计算间隔（时间或帧数），减轻性能压力 |
| `Use Frame Interval` | 使用帧间隔而非时间间隔 | 切换间隔计算模式 |
| `Frame Interval` | 帧间隔数值 | 设置每N帧计算一次 |
| `Time Interval (s)` | 时间间隔数值 | 设置每N秒计算一次 |
| `Use Last Result` | 使用上次结果 | 在跳过计算的帧中复用上次计算结果 |
| `Passthrough Mode` | 直通模式 | 直接输出输入数据而不做任何计算，用于调试输入数据是否正确 |
| `Reverse Ray Direction` | 反转光线方向 | 由于路径追踪中光线方向通常从相机/表面指向光源，需要反转方向进行计算 |
| `Intensity Scale` | 强度缩放 | 调整辐照度强度的缩放因子 |
| `Debug Normal View` | 法线可视化 | 将法线方向可视化为颜色，用于调试 |
| `Use Actual Normals` | 使用实际法线 | 从几何体获取实际法线而非使用固定法线 |
| `Fixed Normal` | 固定法线方向 | 设置用于计算的固定法线方向（当不使用实际法线时） |

## 2. AccumulatePass（辐照度累积通道）

AccumulatePass并非专门为辐照度设计，但是在辐照度计算流水线中用于累积每帧的辐照度结果，以提供更稳定、更准确的辐照度值，特别是在蒙特卡洛积分的情况下。

### 2.1 输入

| 输入通道 | 描述 | 类型 |
|---------|------|------|
| `input` | 需要累积的数据（此处为辐照度） | Texture2D（任意格式） |

### 2.2 输出

| 输出通道 | 描述 | 类型 |
|---------|------|------|
| `output` | 累积后的结果 | Texture2D（通常为RGBA32Float） |

### 2.3 实现方法

AccumulatePass实现了不同精度的时间累积算法，主要包括：

1. **累积方式**：
   - 标准和累积：新帧加入到累积总和中，并计算平均值
   - 在高样本数或长时间渲染时，精度问题变得重要

2. **精度模式**：
   - 单精度(Single)：标准的单精度浮点累积
   - 补偿单精度(SingleCompensated)：使用Kahan求和算法减少舍入误差
   - 双精度(Double)：使用双精度浮点累积，提供最高精度

3. **计算流程**：
   - 准备所需的中间缓冲区（根据精度模式不同而不同）
   - 对于每个像素，根据累积计数计算当前样本权重
   - 将当前样本与累积结果混合
   - 更新累积计数和中间缓冲区
   - 输出当前平均值

4. **溢出处理**：
   - 停止(Stop)：达到最大帧数后停止累积
   - 重置(Reset)：达到最大帧数后重置累积
   - 指数移动平均(EMA)：切换到指数移动平均累积模式

### 2.4 调试选项

| 选项 | 描述 | 作用 |
|-----|------|------|
| `Output size` | 输出尺寸 | 控制输出纹理的大小 |
| `Enabled` | 启用/禁用累积 | 控制是否进行累积处理 |
| `Reset` | 重置累积 | 清除累积数据，重新开始 |
| `Auto Reset` | 自动重置 | 场景变化时自动重置累积 |
| `Mode` | 精度模式 | 选择累积的精度模式（单精度/补偿单精度/双精度） |
| `Max Frame Count` | 最大帧数 | 设置累积的最大帧数 |
| `Overflow Mode` | 溢出模式 | 达到最大帧数后的处理方式 |

## 3. ToneMapper（色调映射通道）

ToneMapper用于将高动态范围(HDR)辐照度值映射到显示设备的低动态范围(LDR)，使辐照度数据能够正确显示。

### 3.1 输入

| 输入通道 | 描述 | 类型 |
|---------|------|------|
| `src` | 源纹理（高动态范围辐照度数据） | Texture2D |

### 3.2 输出

| 输出通道 | 描述 | 类型 |
|---------|------|------|
| `dst` | 色调映射后的输出纹理 | Texture2D |

### 3.3 实现方法

ToneMapper实现了多种色调映射算法和相关处理：

1. **色调映射操作符**：
   - Linear：线性映射，不做处理
   - Reinhard：标准Reinhard色调映射
   - ReinhardModified：带有最大亮度参数的修改版Reinhard
   - HejiHableAlu：Jim Heji操作符的ALU近似
   - HableUc2：John Hable的Uncharted 2电影般色调映射
   - Aces：Academy Color Encoding System的映射

2. **曝光控制**：
   - 自动曝光：基于场景平均亮度自动调整曝光
   - 手动曝光：通过曝光值(EV)、光圈值(f-stop)、快门速度等参数控制

3. **白平衡**：
   - 可设置色温(白点)，调整色彩平衡

4. **处理流程**：
   - 应用曝光值调整
   - 应用色彩变换（包括白平衡）
   - 应用选定的色调映射操作符
   - 可选择是否将输出限制在[0,1]范围

### 3.4 调试选项

| 选项 | 描述 | 作用 |
|-----|------|------|
| `Output Size` | 输出尺寸 | 控制输出纹理的大小 |
| `Use Scene Metadata` | 使用场景元数据 | 加载场景时使用场景提供的色调映射设置 |
| `Exposure Compensation` | 曝光补偿 | 以f-stop为单位调整曝光值 |
| `Auto Exposure` | 自动曝光 | 根据场景平均亮度自动调整曝光 |
| `Operator` | 色调映射算法 | 选择使用的色调映射操作符 |
| `Clamp Output` | 限制输出 | 将输出值限制在[0,1]范围内 |
| `White Balance` | 白平衡 | 启用/禁用白平衡调整 |
| `White Point` | 白点(色温) | 设置白平衡的色温（开尔文） |
| `White Max Luminance` | 最大亮度 | 用于修改版Reinhard操作符的参数 |
| `White Scale` | 白色缩放 | 用于HableUc2操作符的参数 |
| `Film Speed (ISO)` | 感光度 | 设置曝光计算中的ISO值 |
| `F-Number` | 光圈值 | 设置曝光计算中的光圈值 |
| `Shutter` | 快门速度 | 设置曝光计算中的快门速度倒数 |
| `Exposure Mode` | 曝光模式 | 选择曝光计算模式（光圈优先/快门优先等） |

## 4. 辐照度计算流水线

这三个渲染通道在辐照度计算流水线中的协作方式如下：

1. **IrradiancePass**：将路径追踪得到的光线方向和强度数据转换为辐照度值。这个通道执行物理正确的辐照度计算，根据光线与表面法线的夹角对辐射亮度进行加权。

2. **AccumulatePass**：对每帧计算的辐照度值进行时间累积，随着样本数量的增加，结果会逐渐收敛到更准确的辐照度值。这对于使用蒙特卡洛方法的渲染特别重要。

3. **ToneMapper**：将高动态范围的辐照度值映射到显示设备可表现的范围内，确保辐照度数据能够在屏幕上正确可视化。

通过这三个通道的配合，可以实现从光线追踪到最终辐照度可视化的完整流程，提供物理正确且视觉上令人满意的辐照度渲染。
