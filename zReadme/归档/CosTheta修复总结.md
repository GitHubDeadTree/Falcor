# CosTheta修复总结

## 修复清单

1. **恢复正确的CosTheta计算**
   - 取消注释原始的计算代码
   - 删除固定值1.0的返回语句
   - 确保余弦值正确计算和限制

2. **添加调试功能**
   - 创建CosThetaDebugInfo结构体存储计算细节
   - 提供带调试和不带调试的两个函数版本
   - 增加向量可视化函数

3. **调试输出改进**
   - 记录相机法向量和光线方向
   - 记录点积和cosTheta的中间计算结果
   - 在左上角像素提供向量可视化

## 验证方法

1. **查看调试纹理**
   - gDebugInputData：检查光线方向
   - gDebugOutput：检查相机法向量和向量可视化
   - gDebugCalculation：检查计算过程

2. **观察不同视角下的功率变化**
   - 移动相机，观察同一物体在不同角度下的功率值
   - 确认正面入射光线功率最大，斜入射光线功率较小

3. **与理论值比较**
   - 对于已知角度的入射光线，计算预期的CosTheta值
   - 与实际计算结果进行比较，确认误差在可接受范围内

## 要点说明

1. **CosTheta计算公式**
   ```
   cameraNormal = normalize(gCameraTarget - gCameraPosition)
   dotProduct = dot(rayDir, -cameraNormal)
   cosTheta = max(0.0f, dotProduct)
   finalCosTheta = max(cosTheta, 0.01f)
   ```

2. **最小值限制**
   - 使用0.01作为最小cosTheta值
   - 避免掠射光线功率过小，同时保持物理合理性

3. **背面光线处理**
   - 对于背面入射光线（dotProduct < 0），强制cosTheta为0
   - 确保只有进入相机的光线才会贡献功率

## 验证案例

| 场景描述 | 光线方向 | 相机方向 | 预期CosTheta | 实际CosTheta |
|---------|---------|---------|-------------|-------------|
| 正面入射 | (0,0,-1) | (0,0,1) | 1.0         | 待验证       |
| 45度入射 | (0.707,0,-0.707) | (0,0,1) | ~0.707 | 待验证    |
| 掠射    | (1,0,0) | (0,0,1) | 0.01 (最小值) | 待验证       |
| 背面入射 | (0,0,1) | (0,0,1) | 0.0         | 待验证       |

完成以上验证后，应记录实际值并更新此表格。
