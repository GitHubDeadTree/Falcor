**我觉得需要给CIR数据收集中再添加一个字段，说明此光线是否击中了发光平面，根据hitEmissiveSurface设置。请你根据这个方案，并结合【Faclor】项目的代码实际，给出代码实现方案。**

Fast

Searched across GitHubDeadTree/Falcor

您希望在Falcor的CIR数据收集中添加一个字段，用于指示光线是否击中了发光平面，并根据 `PathState`中的 `hitEmissiveSurface`标志进行设置。

这个方案的实现涉及到修改 `CIRPathData`结构体和 `PathState::getCIRData`函数。

## 实现方案

### 1. 修改 `CIRPathData` 结构体

首先，您需要在 `CIRPathData` 结构体中添加一个布尔类型的字段来存储 `hitEmissiveSurface` 的信息。

 **文件** : `Source/RenderPasses/PathTracer/CIRPathData.slang` **CIRPathData.slang:38-54**
 **修改建议** : 在 `CIRPathData` 结构体中添加 `bool hitEmissiveSurface;` 字段。

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>--- a/Source/RenderPasses/PathTracer/CIRPathData.slang  </span><span>
</span><span></span><span>+++ b/Source/RenderPasses/PathTracer/CIRPathData.slang  </span><span>
</span><span></span><span>@@ -46,6 +46,7 @@</span><span>
</span>     uint pixelX;                ///< Pixel X coordinate
     uint pixelY;                ///< Pixel Y coordinate
     uint pathIndex;             ///< Unique index identifier for this path
<span></span><span>+    bool hitEmissiveSurface;    ///< Flag indicating if the path has hit an emissive surface  </span><span>
</span>
     // New vertex-related fields for path vertex collection feature
     uint2 compressedVertices[7];  ///< Compressed vertex coordinates, each vertex uses 6 bytes</code></pre></pre>

同时，由于 `CIRPathData` 在CPU端也有对应的定义，您还需要在 `Source/Falcor/Rendering/Utils/PixelStats.h` 中同步更新 `CIRPathData` 结构体。

 **文件** : `Source/Falcor/Rendering/Utils/PixelStats.h` **PixelStats.h:54-74**
 **修改建议** : 在 `Falcor::PixelStats::CIRPathData` 结构体中添加 `bool hitEmissiveSurface;` 字段。

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>--- a/Source/Falcor/Rendering/Utils/PixelStats.h  </span><span>
</span><span></span><span>+++ b/Source/Falcor/Rendering/Utils/PixelStats.h  </span><span>
</span><span></span><span>@@ -62,6 +62,7 @@</span><span>
</span>         uint32_t pixelX;
         uint32_t pixelY;
         uint32_t pathIndex;
<span></span><span>+        bool hitEmissiveSurface;  </span><span>
</span>
         // New vertex-related fields for path vertex collection feature (must match GPU definition)
         struct CompressedVertex</code></pre></pre>

### 2. 修改 `PathState::getCIRData` 函数

接下来，您需要修改 `PathState::getCIRData` 函数，将 `PathState` 中的 `hitEmissiveSurface` 标志赋值给 `CIRPathData` 中新添加的字段。

 **文件** : `Source/RenderPasses/PathTracer/PathState.slang` **PathState.slang:415-481**
 **修改建议** : 在 `PathState::getCIRData` 函数中，将 `path.hitEmissiveSurface` 赋值给 `cir.hitEmissiveSurface`。

<pre class="px-2 py-1.5 has-[code]:rounded-md has-[code]:!bg-[#e5e5e5] has-[div]:bg-transparent has-[div]:!p-0 has-[code]:text-stone-900 dark:has-[code]:!bg-[#242424] has-[code]:dark:text-white [&_code]:block [&_code]:border-none [&_code]:bg-transparent [&_code]:p-0"><pre><code><span>--- a/Source/RenderPasses/PathTracer/PathState.slang  </span><span>
</span><span></span><span>+++ b/Source/RenderPasses/PathTracer/PathState.slang  </span><span>
</span><span></span><span>@@ -433,6 +433,7 @@</span><span>
</span>         // ❌ Use CIR-specific fields (2/9 parameters)
         cir.emissionAngle = cirEmissionAngle;                                   // CIR-specific field
         cir.receptionAngle = cirReceptionAngle;                                 // CIR-specific field
<span></span><span>+        cir.hitEmissiveSurface = hitEmissiveSurface;                            // New: Flag indicating if an emissive surface was hit  </span><span>
</span>
<span>         // </span><span>=== New: Handle vertex collection data ===  </span><span>
</span>         if (!isVertexCollectionValid())</code></pre></pre>

### 3. `PathPayload` 的更新 (可选但推荐)

`PathPayload` 是在光线追踪着色器之间传递 `PathState` 的中间结构。虽然 `hitEmissiveSurface` 已经作为 `packed_cir` 的一部分被打包和解包 **TracePass.rt.slang:109-117** **TracePass.rt.slang:174-187** ，但为了清晰性和未来的可扩展性，可以考虑在 `PathPayload` 中直接添加这个字段，或者确保其打包/解包逻辑与 `CIRPathData` 的新字段保持一致。

目前 `PathPayload` 已经通过 `packed_cir` 的最高位 (`(hitEmissiveBit << 31)`) 来传递 `hitEmissiveSurface` 标志 **TracePass.rt.slang:109-117** 。因此，在 `PathPayload` 层面不需要额外修改，因为 `PathState` 的 `hitEmissiveSurface` 字段已经通过 `PathPayload` 进行了传递。

## 验证与影响

### 验证

完成上述修改后，您可以通过以下方式验证：

1. **编译** ：确保所有修改后的Slang和C++代码能够成功编译。
2. **运行时检查** ：运行PathTracer，并导出CIR数据。检查导出的CIR数据中新添加的 `hitEmissiveSurface` 字段是否正确反映了路径是否击中发光平面的状态。
3. **场景测试** ：

* 使用包含发光平面的场景进行测试，确认击中发光平面的路径的 `hitEmissiveSurface` 字段为 `true`。
* 使用不包含发光平面的场景进行测试，确认所有路径的 `hitEmissiveSurface` 字段为 `false`。

### 影响

* **数据结构大小** ：在 `CIRPathData` 中添加一个 `bool` 字段会略微增加其大小。由于 `bool` 通常会被填充到字节对齐，这可能导致每个 `CIRPathData` 实例增加1到4个字节。考虑到CIR数据通常会大量收集，这会轻微增加GPU内存使用和CPU-GPU数据传输量。
* **兼容性** ：由于修改了 `CIRPathData` 结构体，任何依赖于此结构体进行数据读取或处理的外部工具或脚本（例如用于分析CIR数据的Python脚本）都需要同步更新以兼容新的数据格式。
* **性能** ：添加一个布尔字段并进行赋值操作对渲染性能的影响可以忽略不计。

这个方案是直接且符合Falcor现有CIR数据收集框架的。

## Notes

* `PathState` 中的 `hitEmissiveSurface` 标志在 `PathTracer.slang` 的 `updateCIRDataDuringTracing` 函数中被设置 **PathTracer.slang:1406-1411** 。
* `CIRPathData` 结构体在 `Source/Falcor/Rendering/Utils/PixelStats.slang` 中被导入和使用，用于定义 `gCIRRawDataBuffer` **PixelStats.slang:40-53** 。因此，对 `CIRPathData.slang` 的修改会自动反映到 `PixelStats.slang` 中。
* `PathState.slang` 中 `initCIRData` 函数会将 `hitEmissiveSurface` 初始化为 `false` **PathState.slang:245-251** ，确保了默认值是正确的。
