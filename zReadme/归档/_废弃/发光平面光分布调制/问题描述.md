# [Falcor] IES Light Profile Loading Error - "Error while loading IES profile"

## 🔍 Problem Description

I'm encountering an issue when trying to load a custom IES light profile in Falcor 4 using Python scripts. The system throws a warning "Error while loading IES profile" but provides no detailed error information, making it difficult to debug.

## ⚠️ Error Message

```
(Warning) Error while loading IES profile from 'D:\Campus\KY\Light\Falcor\Falcor\build\windows-vs2022\bin\Debug\temp_ies\center_low_edge_high.ies'.
```

## 📝 Code Implementation

**Python Scene Script (`mytutorial2.pyscene`):**

```python
# Load IES profile using the method from theoretical documentation
print("=== LOADING IES LIGHT PROFILE ===")
try:
    # Load IES profile through SceneBuilder as documented
    sceneBuilder.loadLightProfile(ies_filepath, normalize=True)
    print(f"*** Successfully loaded IES profile: {ies_filepath} ***")
    print("*** Light profile will be automatically applied to emissive materials ***")
except Exception as e:
    print(f"*** Error loading IES profile: {e} ***")
    print("*** Continuing with standard emissive material ***")

# Create emissive material
emissivePlaneMaterial = StandardMaterial('EmissivePlaneMaterial')
emissivePlaneMaterial.emissiveColor = float3(1.0, 1.0, 1.0)  # White light
emissivePlaneMaterial.emissiveFactor = 100.0  # High brightness
emissivePlaneMaterial.doubleSided = True  # Double-sided emission
```

**IES File Content (`temp_ies/center_low_edge_high.ies`):**

```ies
IESNA:LM-63-2002
[TEST] Custom Light Distribution
[TESTLAB] Python Generated
[ISSUEDATE] 2024
[MANUFAC] Falcor Custom
TILT=NONE
1 1000 1.0 9 1 1 2 0.0 0.0 0.0 1.0 1.0 50.0
0.0 22.5 45.0 67.5 90.0 112.5 135.0 157.5 180.0
0.0
0.0 0.0 100.0 100.0 100.0 100.0 1000.0 1000.0 1000.0
```

**Variable Declaration:**

```python
ies_filepath = "temp_ies/center_low_edge_high.ies"
```

## 🔧 What I've Already Tried

### 1. **File Format Validation**

- Ensured IES file follows IESNA:LM-63-2002 standard format
- Verified header syntax with proper keywords (`[TEST]`, `[TESTLAB]`, etc.)
- Checked `TILT=NONE` declaration

### 2. **File Path Testing**

- Confirmed file exists at the specified relative path
- Tested both relative and absolute path references
- Verified file permissions are accessible

### 3. **IES Data Structure**

- Used simplified 9-point vertical angle distribution (0° to 180°)
- Single horizontal plane (1 horizontal angle at 0°)
- Step-wise candela distribution: `0.0 0.0 100.0 100.0 100.0 100.0 1000.0 1000.0 1000.0`

### 4. **Error Handling**

- Added try-catch blocks, but Falcor only shows warning without throwing Python exceptions
- Python exception handling doesn't catch the internal Falcor C++ warning

### 5. **Previous Attempts**

- Initially tried complex 32x32 photometric data (525+ lines) - same error
- Simplified to minimal 9x1 distribution - still fails
- Tested different candela value ranges

## 🤔 Technical Context

- **Engine**: Falcor 4.x
- **Platform**: Windows (VS2022 Debug build)
- **Language**: Python scene scripting
- **API Used**: `sceneBuilder.loadLightProfile(filepath, normalize=True)`

According to Falcor documentation, the light profile system should:

1. Parse IES files using `LightProfile::createFromIesProfile`
2. Bake photometric data into 2D textures for GPU sampling
3. Apply globally to all emissive materials in the scene

## ❓ Questions

1. **What are the most common causes of IES loading failures in Falcor?**
2. **Are there specific IES format requirements beyond IESNA:LM-63-2002?**
3. **How can I enable verbose logging to get detailed error information?**
4. **Is there a way to validate IES files before loading them into Falcor?**
5. **Are there working IES file examples I can test with?**
6. **Could the issue be related to file encoding (UTF-8 vs ASCII)?**
7. **Are there minimum/maximum limits on photometric data array sizes?**

## 🎯 Expected Behavior

The IES file should load successfully and create a step-wise light distribution:

- 0°-67.5°: 0 candela (center dark)
- 67.5°-135°: 100 candela (medium brightness)
- 135°-180°: 1000 candela (edge bright)

Any insights or solutions would be greatly appreciated! 🙏

**Tags:** `falcor` `ies-lighting` `light-profiles` `python-scripting` `photometrics`




# IES 灯光分布文件加载错误问题分析与解决方案

## 错误原因分析

在 Falcor 引擎中，您遇到的 "Error while loading IES profile" 错误可能由以下几个关键原因导致：

1. **IES 文件格式不符合要求** ：Falcor 对 IES 文件有严格的格式要求，包括支持特定的 IES 标准格式和数据结构。 **LightProfile.cpp:45-54**
2. **数据大小不正确** ：Falcor 期望 IES 文件中的数据元素数量满足特定公式：`headerSize(13) + numHorizontalAngles + numVerticalAngles + (numHorizontalAngles * numVerticalAngles)`。 **LightProfile.cpp:160-174**
3. **缺少必要的 TILT 指令** ：IES 文件必须包含 `TILT=NONE` 行，不支持其他 TILT 选项。 **LightProfile.cpp:136-143**

## 具体问题分析

查看您提供的 IES 文件内容，发现以下问题：

1. 您声明了 9 个垂直角度和 1 个水平角度，但按照 Falcor 的要求，数据总量应为：13 + 1 + 9 + (1*9) = 32 个数值。但您的文件中似乎只有约 17-18 个数值，不符合 Falcor 的解析要求。 **LightProfile.cpp:170-174**
2. 错误信息不详细是因为 Falcor 的错误处理机制将所有 IES 解析错误统一报告为同一个警告信息，没有提供具体错误原因。 **LightProfile.cpp:209-217**

## 解决方案

1. **修正 IES 文件格式** ：

* 确保第一行是支持的格式之一（您使用的 `IESNA:LM-63-2002` 是正确的）
* 确认包含 `TILT=NONE` 行
* 重要的是数据结构：如果您有 9 个垂直角度和 1 个水平角度，请确保有 32 个数值

1. **修改 IES 文件示例** ：以下是修正后的格式示例（注意数据量）：

```
   IESNA:LM-63-2002
   [TEST] Custom Light Distribution
   [TESTLAB] Python Generated
   [ISSUEDATE] 2024
   [MANUFAC] Falcor Custom
   TILT=NONE
   1 1000 1.0 9 1 1 2 0.0 0.0 0.0 1.0 1.0 50.0
   0.0 22.5 45.0 67.5 90.0 112.5 135.0 157.5 180.0
   0.0
   0.0 0.0 100.0 100.0 100.0 100.0 1000.0 1000.0 1000.0
```

1. **检查文件编码** ：确保文件为纯 ASCII 编码或 UTF-8 无 BOM，因为 Falcor 的解析依赖于标准 C 字符串函数。 **LightProfile.cpp:100-107**
2. **启用更详细日志** ：虽然 Falcor 默认不提供详细的 IES 解析错误信息，但您可以尝试在开发环境中设置断点来查看 `parseIesFile` 函数的返回值，了解具体错误类型。 **LightProfile.cpp:90-97**

## 关于您的其他问题

1. **推荐的测试 IES 文件** ：遗憾的是，Falcor 代码中没有直接提供示例 IES 文件。我建议尝试使用一些标准的 IES 工具生成符合规范的文件，如 DIALux 或 Photometric Toolbox。
2. **光度数组限制** ：根据代码，Falcor 要求至少 16 个数值数据，对最大值没有明确限制，但数量必须精确匹配公式。 **LightProfile.cpp:160-163**
3. **验证 IES 文件** ：在导入 Falcor 前，可以使用专业的 IES 查看器（如 IES Viewer）来验证文件是否符合标准。

## 注意事项

* Falcor 的 IES 解析器相对简单，可能不支持所有复杂的 IES 文件格式变体
* 数据量的计算公式是关键，必须精确匹配
* 如果修改后仍有问题，可能需要考虑使用更简单的 IES 文件进行测试，再逐步复杂化

希望这些信息能帮助您解决 IES 灯光分布文件加载的问题！

Notes:

* 解决方案基于 Falcor 代码库中的 LightProfile.cpp 实现
* 错误处理中缺少详细信息是设计限制，不是用户的实现问题
* 数据量要求是导致问题的最可能原因
