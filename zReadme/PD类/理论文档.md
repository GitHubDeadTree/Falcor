# 光电探测器（Photodetector）设计理论文档

## 1. 项目背景与目标

### 背景

* 在基于 Falcor 的可见光通信（VLC）光线追踪仿真中，需要将光线追踪模块输出的光线信息转换为 PD 的光功率数据，用于后续系统级分析。

### 目标

* 设计并实现一个 `Photodetector` 类，其核心任务是：
* 接收大量光线（每条携带 Radiance、波长、入射角度等属性）
* 将 Radiance 转换为光功率
* 按波长和入射角分类累加功率
* 输出结构化的波长–入射角度–光功率表

## 2. 需求总览

| 序号 | 需求点     | 说明                                                               |
| ---- | ---------- | ------------------------------------------------------------------ |
| 1    | 接口规范   | 定义 Photodetector 类的输入输出接口                                |
| 2    | 核心功能   | Radiance→光功率转换、分类累加、结果导出                           |
| 3    | 输入字段   | Radiance、波长 λ、入射角 θ、每光线代表立体角 Δω、PD 有效面积 A |
| 4    | 输出字段   | 波长–入射角度–光功率表、总功率 P_total                           |
| 5    | 计算公式   | 核心转换与累加公式                                                 |
| 6    | 数据表设计 | 分类表结构：波长 bins × 角度 bins                                 |
| 7    | 性能与精度 | 光线数 N、Δω 计算、bin 大小、内存与并行策略                      |
| 8    | 边界与异常 | 波长超出范围、极端入射角、无光线命中                               |

## 3. 功能模块与接口

### 3.1 类名与职责

```Plain
class Photodetector
├─ 初始化设置
│   ├─ 设置 PD 有效面积 A
│   ├─ 设置波长分箱（\lambda\_bins）
│   └─ 设置角度分箱（\theta\_bins）
├─ 接收光线（receiveRay）
│   └─ 累加单条光线功率到对应 [i,j]
├─ 结果导出（exportResults）
│   └─ 输出分类表及总功率 P_{total}
```

### 3.2 核心接口（伪签名）

* `void init(float detectorArea, vector<float> λ_bins, vector<float> θ_bins, float sourceSolidAngle, int numRays)`
* `void receiveRay(float radiance, float wavelength, float incidentAngle)`
* `Results exportResults()`

## 4. 输入与输出

### 4.1 输入（每条光线）

| 名称          | 类型  | 单位          | 说明                    |
| ------------- | ----- | ------------- | ----------------------- |
| radiance (L)  | float | W / (m²·sr) | 光线追踪返回的 Radiance |
| wavelength    | float | nm            | 光波长                  |
| incidentAngle | float | deg           | 光线与 PD 法线夹角      |

### 全局配置输入

| 名称             | 类型   | 单位 | 说明                                                        |
| ---------------- | ------ | ---- | ----------------------------------------------------------- |
| detectorArea (A) | float  | m²  | PD 的有效接收面积                                           |
| sourceSolidAngle | float  | sr   | 光源相对于 PD 的视立体角                                    |
| numRays (N)      | int    | —   | 从相机发出的均匀采样光线总数                                |
| λ_bins          | vector | nm   | 波长分箱边界（如 [400,450,…,700]）建议作为可以自定义的参数 |
| θ_bins          | vector | deg  | 入射角分箱边界（如 [0,10,…,90]）建议作为可以自定义的参数   |

### 4.2 输出

#### 4.2.1 分类表

* **结构** ：二维矩阵 `P[i][j]`
* `i` 对应波长 bin
* `j` 对应角度 bin
* **含义** ：落入 `(λ_i, θ_j)` 区间的累积光功率（W）

#### 4.2.2 汇总结果

| 字段       | 类型  | 单位 | 说明                     |
| ---------- | ----- | ---- | ------------------------ |
| totalPower | float | W    | 所有光线累加的总接收功率 |

## 5. 核心计算方案与公式

### 5.1 每条光线功率计算

 **公式** ：

* **
  $$
  L_
  $$

  **：第 i 条光线的 Radiance（W/m²·sr）
* **
  $$
  \theta_
  $$

  **：入射角（deg→rad）
* **
  $$
  \Delta\omega = \frac{\Omega_s}{N
  $$

  **：每条光线代表的立体角（sr）
* **$$$$**：PD 整体接收面积（m²）

### 5.2 分类累加

 **流程** ：

1. 确定波长 bin：满足 **
   $$
   \lambda_{i} \le \lambda < \lambda_{i+1
   $$

   **
2. 确定角度 bin：满足 **
   $$
   \theta_{j} \le \theta < \theta_{j+1
   $$

   **
3. 累加功率： **
   $$
   P[i][j] += \Delta P_
   $$

   **

### 5.3 总功率



## 6. 数据表设计

### 6.1 波长–角度–功率矩阵

| 波长 nm → / 角度 deg ↓ | 0–10      | 10–20     | … | 80–90     |
| ------------------------ | ---------- | ---------- | -- | ---------- |
| 400–450                 | P[0][0]    | P[0][1]    | … | P[0][8]    |
| …                       | …         | …         | … | …         |
| 650–700                 | P[M–1][0] | P[M–1][1] | … | P[M–1][8] |

### 6.2 辅助查找表

* **角度边界数组** ：`θ_bins = [0,10,…,90]`
* **波长边界数组** ：`λ_bins = [400,450,…,700]`

## 7. 注意事项与挑战

| 类别     | 问题                       | 建议或解决方案                                         |
| -------- | -------------------------- | ------------------------------------------------------ |
| 立体角   | 光源立体角 Ω_s 计算精度   | ``                                              |
| 采样数   | 光线总数 N 与精度/性能折中 | N 越大精度越高; 建议并行累加、分批处理。               |
| 分箱粒度 | λ_bins、θ_bins 选取      | 粒度过细内存大；过粗分辨率低；可根据带宽与响应度调整。 |
| 极端值   | 波长/角度落界外            | 1. 丢弃；2. 合并至边缘 bin；3. 日志警告。              |

## 8. 总结与要点归纳

1. **核心思路** ：Radiance → 光功率 → 波长/角度分类 → 输出表 + 总功率。
2. **必备参数** ：PD 面积 A、光源视立体角 Ω_s、光线数 N、λ_bins/θ_bins。
3. **关键公式** ：
4. **数据结构** ：`P[i][j]` 矩阵 + 辅助边界数组。
5. **注意** ：立体角精度、采样策略、分箱方案、极端值处理。
